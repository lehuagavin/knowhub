# 第1课：环境搭建与第一个程序

## 1.1 什么是 Rust

Rust 是一门系统级编程语言，专注于安全、并发和性能。它的主要特点：

- **内存安全**：在编译时防止空指针、内存泄漏等问题
- **零成本抽象**：高级特性不会带来运行时开销
- **无垃圾回收**：通过所有权系统管理内存，无 GC 停顿
- **现代工具链**：优秀的包管理器、格式化工具、错误提示

Rust 适合开发：操作系统、游戏引擎、Web 后端、命令行工具、嵌入式系统、WebAssembly 等。

## 1.2 Rust 工具链概览

在开始之前，先了解 Rust 的核心工具：

| 工具 | 作用 |
|------|------|
| **rustup** | 安装和管理 Rust 版本 |
| **rustc** | Rust 编译器 |
| **cargo** | 包管理器和构建工具 |
| **rustfmt** | 代码格式化 |
| **clippy** | 代码检查（lint） |

它们的关系：

```
rustup（版本管理器）
  └── 管理多个工具链
       ├── rustc（编译器）
       ├── cargo（包管理）
       ├── rustfmt（格式化）
       └── clippy（检查）
```

## 1.3 安装 rustup

rustup 是 Rust 官方的安装器和版本管理工具。**安装 rustup 会自动安装 rustc、cargo 等工具**。

### Linux / macOS 安装

打开终端，执行：

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

安装过程会提示选项，直接按 `1` 选择默认安装即可：

```
1) Proceed with standard installation (default - just press enter)
2) Customize installation
3) Cancel installation
```

安装完成后，**重启终端**或执行以下命令使环境变量生效：

```bash
source "$HOME/.cargo/env"
```

### Windows 安装

1. 访问 https://rustup.rs
2. 下载 `rustup-init.exe`
3. 双击运行，按提示操作
4. 安装完成后重启命令提示符或 PowerShell

> **注意**：Windows 上可能需要先安装 [Visual Studio C++ Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/)

### 验证安装

```bash
rustc --version
# 输出示例：rustc 1.75.0 (82e1608df 2023-12-21)

cargo --version
# 输出示例：cargo 1.75.0 (1d8b05cdd 2023-11-20)

rustup --version
# 输出示例：rustup 1.26.0 (2023-11-14)
```

如果三个命令都能正常输出版本号，说明安装成功。

### 安装路径说明

rustup 默认安装位置：

| 系统 | 路径 |
|------|------|
| Linux/macOS | `~/.cargo/bin`（可执行文件）<br>`~/.rustup`（工具链） |
| Windows | `%USERPROFILE%\.cargo\bin`<br>`%USERPROFILE%\.rustup` |

环境变量 `PATH` 会自动添加 `~/.cargo/bin`，这样你可以直接使用 `rustc`、`cargo` 等命令。

## 1.4 rustup 使用详解

### 发布渠道

Rust 有三个发布渠道：

| 渠道 | 发布频率 | 稳定性 | 适用场景 |
|------|---------|--------|---------|
| **stable** | 每 6 周 | 稳定 | 日常开发、生产环境 |
| **beta** | 每 6 周 | 较稳定 | 测试即将发布的版本 |
| **nightly** | 每天 | 可能不稳定 | 尝试实验性功能 |

**初学者使用 stable 即可**，这也是默认安装的版本。

### 常用命令

```bash
# 查看已安装的工具链和当前使用的版本
rustup show

# 更新 Rust 到最新版本
rustup update

# 安装其他版本
rustup install nightly
rustup install 1.70.0

# 切换默认版本
rustup default stable
rustup default nightly

# 为当前项目目录指定版本
rustup override set nightly

# 安装额外组件
rustup component add rustfmt    # 代码格式化
rustup component add clippy     # 代码检查
rustup component add rust-src   # 源码（IDE 补全需要）

# 查看已安装的组件
rustup component list --installed
```

### 工具链目录结构

```
~/.rustup/
├── toolchains/                    # 已安装的工具链
│   ├── stable-x86_64-unknown-linux-gnu/
│   │   ├── bin/
│   │   │   ├── rustc             # 编译器
│   │   │   ├── cargo             # 包管理器
│   │   │   └── ...
│   │   └── lib/
│   └── nightly-x86_64-unknown-linux-gnu/
├── settings.toml                  # rustup 配置
└── update-hashes/                 # 更新校验文件

~/.cargo/
├── bin/                           # 代理程序和已安装的工具
│   ├── rustc                      # 代理到实际的 rustc
│   ├── cargo                      # 代理到实际的 cargo
│   └── ...
├── registry/                      # 下载的依赖缓存
└── config.toml                    # cargo 全局配置
```

### 版本选择机制

当你运行 `rustc` 或 `cargo` 时，rustup 按以下优先级选择版本：

1. 检查当前目录的 `rust-toolchain.toml` 或 `rust-toolchain` 文件
2. 检查当前目录是否有 `rustup override`
3. 检查环境变量 `RUSTUP_TOOLCHAIN`
4. 使用默认工具链（`rustup default` 设置的）

### 项目级版本锁定

在项目根目录创建 `rust-toolchain.toml`：

```toml
[toolchain]
channel = "1.75.0"
components = ["rustfmt", "clippy"]
```

团队成员克隆项目后，rustup 会自动下载并使用指定版本。

## 1.5 Cargo：项目管理工具

Cargo 是 Rust 的构建系统和包管理器，类似于：
- Node.js 的 npm
- Python 的 pip + setuptools
- Java 的 Maven

### 创建项目

```bash
# 创建一个新项目
cargo new hello_rust

# 进入项目目录
cd hello_rust
```

### 项目结构

```
hello_rust/
├── Cargo.toml        # 项目配置文件（类似 package.json）
├── Cargo.lock        # 依赖锁定文件（自动生成）
├── src/
│   └── main.rs       # 程序入口
└── target/           # 编译输出目录（自动生成）
```

### Cargo.toml 解析

```toml
[package]
name = "hello_rust"        # 项目名称
version = "0.1.0"          # 版本号
edition = "2021"           # Rust 版本（2015/2018/2021/2024）

[dependencies]
# 在这里添加依赖，例如：
# serde = "1.0"
# tokio = { version = "1", features = ["full"] }
```

### 常用命令

```bash
cargo new project_name    # 创建新项目
cargo init                # 在当前目录初始化项目

cargo build               # 编译项目（Debug 模式）
cargo build --release     # 编译项目（Release 模式，优化）

cargo run                 # 编译并运行
cargo run --release       # 以 Release 模式运行

cargo check               # 快速检查代码是否能编译（不生成可执行文件）
cargo test                # 运行测试
cargo doc --open          # 生成并打开文档

cargo fmt                 # 格式化代码（需要 rustfmt 组件）
cargo clippy              # 代码检查（需要 clippy 组件）
```

## 1.6 Hello World

### 编写代码

打开 `src/main.rs`，内容如下：

```rust
fn main() {
    println!("Hello, World!");
}
```

### 运行程序

```bash
cargo run
```

输出：

```
   Compiling hello_rust v0.1.0 (/path/to/hello_rust)
    Finished dev [unoptimized + debuginfo] target(s) in 0.50s
     Running `target/debug/hello_rust`
Hello, World!
```

### 代码解析

```rust
fn main() {                      // 1. 主函数，程序入口
    println!("Hello, World!");   // 2. 打印宏
}                                // 3. 函数结束
```

1. **`fn main()`**：定义主函数，`fn` 是 function 的缩写，每个可执行程序必须有 `main` 函数
2. **`println!`**：打印宏，`!` 表示这是宏而非普通函数。宏可以接受可变数量的参数
3. **`"Hello, World!"`**：字符串字面量
4. **`;`**：语句结束符，Rust 中大多数语句需要分号

### 直接使用 rustc 编译

除了 Cargo，也可以直接使用编译器：

```bash
rustc src/main.rs -o hello
./hello
```

但实际开发中推荐使用 Cargo，因为它能自动管理依赖和构建配置。

## 1.7 Debug vs Release 构建

```bash
cargo build              # Debug 构建
cargo build --release    # Release 构建
```

| 特性 | Debug | Release |
|------|-------|---------|
| 编译速度 | 快 | 慢 |
| 运行速度 | 慢 | 快（优化后快 10-100 倍） |
| 文件大小 | 大 | 小 |
| 调试信息 | 有 | 无 |
| 输出目录 | `target/debug/` | `target/release/` |

开发时使用 Debug，发布时使用 Release。

## 1.8 注释

```rust
// 单行注释

/*
   多行注释
   可以跨越多行
*/

/// 文档注释 - 用于函数/结构体的说明
/// 支持 Markdown 语法
///
/// # Examples
/// ```
/// let result = add(1, 2);
/// ```
fn add(a: i32, b: i32) -> i32 {
    a + b
}

//! 模块级文档注释
//! 放在文件开头，描述整个模块或 crate
```

## 1.9 开发环境配置

### VS Code（推荐）

安装以下扩展：

1. **rust-analyzer**：语法高亮、代码补全、错误提示、重构
2. **CodeLLDB**：调试支持
3. **Even Better TOML**：TOML 文件支持
4. **Error Lens**（可选）：内联显示错误信息

### 其他 IDE

- **RustRover**：JetBrains 出品，功能强大
- **Vim/Neovim**：配合 rust-analyzer LSP
- **Emacs**：配合 rustic-mode

### Cargo 配置优化

创建 `~/.cargo/config.toml`（全局）或项目下 `.cargo/config.toml`：

```toml
[alias]
r = "run"
b = "build"
c = "check"
t = "test"

[build]
# Linux 上使用更快的链接器（需安装 mold）
# rustflags = ["-C", "link-arg=-fuse-ld=mold"]

[net]
# 国内用户可配置镜像源
# git-fetch-with-cli = true
```

## 1.10 常见问题

### Q: rustup update 很慢怎么办？

配置国内镜像，在 `~/.bashrc` 或 `~/.zshrc` 中添加：

```bash
export RUSTUP_DIST_SERVER="https://rsproxy.cn"
export RUSTUP_UPDATE_ROOT="https://rsproxy.cn/rustup"
```

### Q: cargo build 下载依赖很慢？

在 `~/.cargo/config.toml` 中配置 crates.io 镜像：

```toml
[source.crates-io]
replace-with = "rsproxy"

[source.rsproxy]
registry = "https://rsproxy.cn/crates.io-index"

[registries.rsproxy]
index = "https://rsproxy.cn/crates.io-index"
```

### Q: 如何卸载 Rust？

```bash
rustup self uninstall
```

### Q: 如何查看 Rust 文档（离线）？

```bash
rustup doc              # 打开标准库文档
rustup doc --book       # 打开 The Rust Book
rustup doc --std        # 打开标准库 API 文档
```

## 1.11 练习

1. 安装 Rust 并验证安装成功
2. 创建一个新项目，输出你的名字
3. 尝试 `cargo check` 和 `cargo build` 命令，观察区别
4. 修改代码制造一个语法错误，观察编译器的错误提示
5. 运行 `rustup doc --book` 打开 Rust 官方教程

## 知识要点总结

1. **rustup** 是 Rust 版本管理器，用于安装和切换 Rust 版本
2. **cargo** 是项目管理工具，用于创建项目、编译、运行、测试
3. **rustc** 是编译器，通常通过 cargo 间接使用
4. `fn main()` 是程序入口
5. `println!` 是宏（带 `!`），用于输出
6. 开发用 Debug 构建，发布用 Release 构建
