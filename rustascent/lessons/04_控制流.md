# 第4课：控制流

## 4.1 if 表达式

```rust
fn main() {
    let number = 7;

    // 基本 if
    if number < 5 {
        println!("小于 5");
    } else {
        println!("大于等于 5");
    }

    // if-else if-else
    if number < 0 {
        println!("负数");
    } else if number == 0 {
        println!("零");
    } else {
        println!("正数");
    }
}
```

### 条件必须是 bool

```rust
fn main() {
    let number = 3;

    // 错误：Rust 不会自动转换类型
    // if number {  // 错误！
    //     println!("number is non-zero");
    // }

    // 正确
    if number != 0 {
        println!("number is non-zero");
    }
}
```

### if 是表达式

```rust
fn main() {
    let condition = true;

    // if 作为表达式赋值
    let number = if condition { 5 } else { 6 };
    println!("number = {}", number);  // 5

    // 两个分支类型必须相同
    // let bad = if condition { 5 } else { "six" };  // 错误！
}
```

## 4.2 loop 循环

```rust
fn main() {
    let mut count = 0;

    // 无限循环
    loop {
        count += 1;
        println!("count = {}", count);

        if count == 5 {
            break;  // 退出循环
        }
    }
}
```

### loop 返回值

```rust
fn main() {
    let mut counter = 0;

    let result = loop {
        counter += 1;

        if counter == 10 {
            break counter * 2;  // 返回值
        }
    };

    println!("result = {}", result);  // 20
}
```

### 循环标签

```rust
fn main() {
    let mut count = 0;

    'outer: loop {
        println!("count = {}", count);
        let mut remaining = 10;

        loop {
            println!("remaining = {}", remaining);
            if remaining == 9 {
                break;  // 退出内层循环
            }
            if count == 2 {
                break 'outer;  // 退出外层循环
            }
            remaining -= 1;
        }

        count += 1;
    }
    println!("End count = {}", count);
}
```

## 4.3 while 循环

```rust
fn main() {
    let mut number = 3;

    while number != 0 {
        println!("{}!", number);
        number -= 1;
    }

    println!("发射！");
}
```

## 4.4 for 循环

```rust
fn main() {
    // 遍历数组
    let arr = [10, 20, 30, 40, 50];
    for element in arr {
        println!("值: {}", element);
    }

    // 使用 Range
    for number in 1..4 {  // 1, 2, 3（不包含 4）
        println!("{}", number);
    }

    // 包含结束值
    for number in 1..=4 {  // 1, 2, 3, 4
        println!("{}", number);
    }

    // 反向遍历
    for number in (1..4).rev() {  // 3, 2, 1
        println!("{}", number);
    }
}
```

### 遍历时获取索引

```rust
fn main() {
    let arr = ['a', 'b', 'c', 'd'];

    for (index, value) in arr.iter().enumerate() {
        println!("索引 {} 的值是 {}", index, value);
    }
}
```

### 遍历的不同方式

```rust
fn main() {
    let vec = vec![1, 2, 3];

    // 借用遍历
    for v in &vec {
        println!("{}", v);
    }
    // vec 仍然可用

    // 可变借用遍历
    let mut vec2 = vec![1, 2, 3];
    for v in &mut vec2 {
        *v *= 2;
    }
    println!("{:?}", vec2);  // [2, 4, 6]

    // 消耗遍历（获取所有权）
    for v in vec {
        println!("{}", v);
    }
    // vec 不再可用
}
```

## 4.5 match 表达式

```rust
fn main() {
    let number = 3;

    match number {
        1 => println!("一"),
        2 => println!("二"),
        3 => println!("三"),
        _ => println!("其他"),  // 通配符
    }
}
```

### match 是表达式

```rust
fn main() {
    let number = 2;

    let text = match number {
        1 => "一",
        2 => "二",
        3 => "三",
        _ => "其他",
    };

    println!("{}", text);  // 二
}
```

### 匹配多个值

```rust
fn main() {
    let number = 5;

    match number {
        1 | 2 => println!("一或二"),
        3..=5 => println!("三到五"),
        _ => println!("其他"),
    }
}
```

### 匹配守卫

```rust
fn main() {
    let number = Some(4);

    match number {
        Some(x) if x < 5 => println!("小于 5: {}", x),
        Some(x) => println!("大于等于 5: {}", x),
        None => println!("没有值"),
    }
}
```

### 解构匹配

```rust
fn main() {
    // 元组解构
    let point = (3, 5);
    match point {
        (0, 0) => println!("原点"),
        (0, y) => println!("在 y 轴上, y = {}", y),
        (x, 0) => println!("在 x 轴上, x = {}", x),
        (x, y) => println!("点 ({}, {})", x, y),
    }

    // 结构体解构
    struct Point {
        x: i32,
        y: i32,
    }

    let p = Point { x: 0, y: 7 };
    match p {
        Point { x: 0, y } => println!("在 y 轴上, y = {}", y),
        Point { x, y: 0 } => println!("在 x 轴上, x = {}", x),
        Point { x, y } => println!("点 ({}, {})", x, y),
    }
}
```

### @ 绑定

```rust
fn main() {
    let number = 5;

    match number {
        n @ 1..=5 => println!("1-5 范围内: {}", n),
        n @ 6..=10 => println!("6-10 范围内: {}", n),
        n => println!("其他: {}", n),
    }
}
```

## 4.6 if let 简化匹配

```rust
fn main() {
    let some_value = Some(3);

    // 使用 match
    match some_value {
        Some(3) => println!("三!"),
        _ => (),
    }

    // 使用 if let（更简洁）
    if let Some(3) = some_value {
        println!("三!");
    }

    // 带 else
    if let Some(value) = some_value {
        println!("有值: {}", value);
    } else {
        println!("没有值");
    }
}
```

## 4.7 while let 循环

```rust
fn main() {
    let mut stack = vec![1, 2, 3];

    // 当 pop() 返回 Some 时继续循环
    while let Some(top) = stack.pop() {
        println!("{}", top);
    }
    // 输出: 3, 2, 1
}
```

## 4.8 let else

```rust
fn main() {
    let some_value: Option<i32> = Some(42);

    // let else 模式
    let Some(value) = some_value else {
        println!("没有值，退出");
        return;
    };

    println!("值是: {}", value);
}

fn get_config_value(config: Option<&str>) -> &str {
    let Some(value) = config else {
        return "default";
    };
    value
}
```

## 4.9 continue 和 break

```rust
fn main() {
    // continue 跳过当前迭代
    for i in 1..10 {
        if i % 2 == 0 {
            continue;  // 跳过偶数
        }
        println!("{}", i);  // 只打印奇数
    }

    // break 退出循环
    for i in 1..100 {
        if i > 5 {
            break;
        }
        println!("{}", i);
    }
}
```

## 4.10 常见模式

### 查找元素

```rust
fn main() {
    let numbers = vec![1, 2, 3, 4, 5];

    // 使用 for 循环
    let mut found = None;
    for &n in &numbers {
        if n == 3 {
            found = Some(n);
            break;
        }
    }

    // 使用迭代器（更简洁）
    let found = numbers.iter().find(|&&x| x == 3);
}
```

### 累加

```rust
fn main() {
    let numbers = vec![1, 2, 3, 4, 5];

    // 使用 for 循环
    let mut sum = 0;
    for n in &numbers {
        sum += n;
    }

    // 使用迭代器
    let sum: i32 = numbers.iter().sum();
}
```

## 知识要点总结

1. `if` 是表达式，可以返回值
2. `loop` 创建无限循环，可以用 `break` 返回值
3. `while` 根据条件循环
4. `for` 遍历迭代器，最常用
5. `match` 是强大的模式匹配，必须穷尽所有可能
6. `if let` 简化只关心一个模式的 `match`
7. `while let` 持续匹配直到失败
8. 循环标签允许 `break` 和 `continue` 指定目标循环
