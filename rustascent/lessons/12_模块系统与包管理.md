# 第12课：模块系统与包管理

## 12.1 Rust 模块系统概览

Rust 的模块系统包含：
- **包（Package）**：一个 Cargo 项目，包含 `Cargo.toml`
- **Crate**：编译单元，分为二进制 crate 和库 crate
- **模块（Module）**：组织代码的命名空间
- **路径（Path）**：引用模块中项目的方式

## 12.2 Crate

### 二进制 Crate

有 `main` 函数，编译为可执行文件。

```
src/main.rs  → 二进制 crate 的根
```

### 库 Crate

没有 `main` 函数，提供 API 给其他代码使用。

```
src/lib.rs   → 库 crate 的根
```

### 一个包可以同时包含两者

```
my_project/
├── Cargo.toml
├── src/
│   ├── main.rs    # 二进制 crate
│   └── lib.rs     # 库 crate
```

## 12.3 定义模块

### 在单个文件中

```rust
// src/lib.rs

// 公开模块
pub mod front_of_house {
    // 公开模块
    pub mod hosting {
        pub fn add_to_waitlist() {
            println!("Added to waitlist");
        }

        fn seat_at_table() {
            println!("Seated at table");
        }
    }

    // 私有模块
    mod serving {
        fn take_order() {}
        fn serve_order() {}
        fn take_payment() {}
    }
}

pub fn eat_at_restaurant() {
    // 绝对路径
    crate::front_of_house::hosting::add_to_waitlist();

    // 相对路径
    front_of_house::hosting::add_to_waitlist();
}
```

### 文件系统分离模块

```
src/
├── lib.rs
├── front_of_house.rs          # 或 front_of_house/mod.rs
└── front_of_house/
    ├── hosting.rs
    └── serving.rs
```

```rust
// src/lib.rs
pub mod front_of_house;  // 声明模块，从文件加载

pub fn eat_at_restaurant() {
    front_of_house::hosting::add_to_waitlist();
}
```

```rust
// src/front_of_house.rs
pub mod hosting;
mod serving;
```

```rust
// src/front_of_house/hosting.rs
pub fn add_to_waitlist() {
    println!("Added to waitlist");
}
```

```rust
// src/front_of_house/serving.rs
fn take_order() {}
fn serve_order() {}
```

## 12.4 可见性（pub）

### 默认私有

```rust
mod outer {
    fn private_function() {}  // 私有，外部无法访问
    pub fn public_function() {}  // 公开

    pub mod inner {
        pub fn inner_public() {}
        fn inner_private() {}
    }
}

fn main() {
    outer::public_function();         // 可以
    outer::inner::inner_public();     // 可以
    // outer::private_function();     // 错误！私有
    // outer::inner::inner_private(); // 错误！私有
}
```

### 结构体字段可见性

```rust
mod my_mod {
    pub struct User {
        pub name: String,     // 公开字段
        email: String,        // 私有字段
    }

    impl User {
        pub fn new(name: String, email: String) -> User {
            User { name, email }
        }

        pub fn email(&self) -> &str {
            &self.email
        }
    }
}

fn main() {
    let user = my_mod::User::new(
        String::from("Alice"),
        String::from("alice@example.com"),
    );

    println!("Name: {}", user.name);        // 可以
    // println!("Email: {}", user.email);    // 错误！字段私有
    println!("Email: {}", user.email());     // 可以，通过方法
}
```

### pub 的限定形式

```rust
pub(crate) fn crate_only() {}      // 仅当前 crate 可见
pub(super) fn parent_only() {}      // 仅父模块可见
pub(in crate::my_mod) fn specific() {} // 指定路径可见
```

## 12.5 use 关键字

```rust
// 引入路径
use std::collections::HashMap;

// 引入多个
use std::io::{self, Read, Write};

// 引入所有公开项（一般不推荐）
use std::collections::*;

fn main() {
    let mut map = HashMap::new();
    map.insert("key", "value");
}
```

### 重命名

```rust
use std::fmt::Result;
use std::io::Result as IoResult;

fn function1() -> Result {
    Ok(())
}

fn function2() -> IoResult<()> {
    Ok(())
}
```

### 重导出

```rust
// src/lib.rs
mod internal {
    pub fn helper() {}
}

// 重导出，外部用户可以直接 use my_crate::helper
pub use internal::helper;
```

## 12.6 super 和 self

```rust
mod parent {
    pub fn parent_function() {
        println!("parent function");
    }

    pub mod child {
        pub fn child_function() {
            // 使用 super 访问父模块
            super::parent_function();

            // 使用 self 引用当前模块
            self::helper();
        }

        fn helper() {
            println!("helper");
        }
    }
}
```

## 12.7 Cargo 依赖管理

### Cargo.toml

```toml
[package]
name = "my_project"
version = "0.1.0"
edition = "2021"
authors = ["Your Name <you@example.com>"]
description = "A description"
license = "MIT"

[dependencies]
serde = "1.0"                        # 最新 1.x.x
serde_json = "1.0.108"               # 精确版本
rand = { version = "0.8", features = ["small_rng"] }
my_lib = { path = "../my_lib" }      # 本地路径
my_git_lib = { git = "https://github.com/user/repo" }

[dev-dependencies]
criterion = "0.5"  # 仅测试/基准使用

[build-dependencies]
cc = "1.0"  # 仅构建脚本使用
```

### 版本语义

```
"1.0.0"    → 精确版本
"^1.0.0"   → >=1.0.0, <2.0.0（默认）
"~1.0.0"   → >=1.0.0, <1.1.0
"1.0.*"    → >=1.0.0, <1.1.0
">=1.0.0"  → 大于等于 1.0.0
```

### Cargo.lock

- **应用程序**：应提交 `Cargo.lock`（确保可重现构建）
- **库**：不应提交 `Cargo.lock`（让用户决定版本）

### 常用 Cargo 命令

```bash
cargo new project_name        # 创建新项目
cargo add serde               # 添加依赖
cargo add serde --features derive  # 带 feature
cargo remove serde            # 移除依赖
cargo update                  # 更新依赖
cargo tree                    # 查看依赖树
cargo doc --open              # 生成并打开文档
```

## 12.8 工作空间（Workspace）

管理多个相关的包：

```toml
# 根目录 Cargo.toml
[workspace]
members = [
    "common",
    "server",
    "client",
]
```

```
my_workspace/
├── Cargo.toml       # workspace 配置
├── common/
│   ├── Cargo.toml
│   └── src/lib.rs
├── server/
│   ├── Cargo.toml   # [dependencies] common = { path = "../common" }
│   └── src/main.rs
└── client/
    ├── Cargo.toml
    └── src/main.rs
```

## 12.9 Feature Flags

```toml
# Cargo.toml
[features]
default = ["json"]
json = ["serde", "serde_json"]
xml = ["quick-xml"]
full = ["json", "xml"]

[dependencies]
serde = { version = "1.0", optional = true }
serde_json = { version = "1.0", optional = true }
quick-xml = { version = "0.30", optional = true }
```

```rust
// 条件编译
#[cfg(feature = "json")]
pub mod json_support {
    pub fn parse_json(data: &str) {
        // ...
    }
}
```

## 12.10 组织大型项目

### 推荐结构

```
my_project/
├── Cargo.toml
├── src/
│   ├── lib.rs          # 库入口
│   ├── main.rs         # 二进制入口
│   ├── config.rs       # 配置模块
│   ├── error.rs        # 错误定义
│   ├── models/         # 数据模型
│   │   ├── mod.rs
│   │   ├── user.rs
│   │   └── post.rs
│   ├── services/       # 业务逻辑
│   │   ├── mod.rs
│   │   ├── auth.rs
│   │   └── database.rs
│   └── utils/          # 工具函数
│       ├── mod.rs
│       └── helpers.rs
├── tests/              # 集成测试
│   └── integration.rs
├── benches/            # 基准测试
│   └── benchmarks.rs
└── examples/           # 示例代码
    └── basic.rs
```

## 知识要点总结

1. **Package** 包含一个或多个 crate
2. **模块**使用 `mod` 定义，默认私有
3. **pub** 控制可见性，可以限定范围
4. **use** 引入路径，简化使用
5. **super** 访问父模块，**self** 访问当前模块
6. **Cargo.toml** 管理依赖和项目配置
7. **Workspace** 管理多个相关包
8. **Feature flags** 实现条件编译
